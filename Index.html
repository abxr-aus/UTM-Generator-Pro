<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UTM Generator Pro</title>
  <meta name="description" content="Professional UTM link builder with presets, QR, bulk export, and theme toggle." />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* UTM Generator Pro – modern, responsive UI with dark/light themes */
:root{
  --bg:#0b0c10; --card:#151821; --muted:#9fb0c7; --text:#eaf0ff;
  --accent:#4e8cff; --accent-2:#6ee7b7; --danger:#ff6b6b; --border:#273043;
  --focus:#93c5fd; --success:#22c55e; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
}
html[data-theme="light"]{
  --bg:#f6f8fc; --card:#ffffff; --muted:#5b6677; --text:#111827;
  --accent:#2563eb; --accent-2:#059669; --danger:#e11d48; --border:#e5e7eb;
  --focus:#93c5fd; --success:#16a34a; --shadow:0 6px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  color:var(--text);
  background:var(--bg);
}
.appbar{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 18px; position:sticky; top:0; z-index:20;
  background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0)) , var(--bg);
  backdrop-filter:saturate(140%) blur(6px);
  border-bottom:1px solid var(--border);
}
.brand{display:flex; gap:10px; align-items:center}
.logo{
  display:inline-grid; place-items:center; width:34px; height:34px; border-radius:10px;
  background:linear-gradient(145deg, var(--accent), var(--accent-2));
  color:#fff; font-weight:900;
}
.app-actions{display:flex; gap:8px; align-items:center}
.wrap{max-width:1000px; margin:28px auto; padding:0 18px}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); padding:22px; margin-bottom:18px;
}
.toolbar{display:flex; gap:24px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap}
.field{margin-bottom:12px}
.field.inline{display:flex; gap:16px; align-items:center}
.field label{display:block; margin-bottom:6px; font-weight:600}
.req{color:var(--accent-2)}
.hint{display:block; color:var(--muted); font-size:.86rem; margin-top:6px}
input[type="text"], input[type="url"], select{
  width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px;
  background:transparent; color:var(--text); outline:none;
  transition:border-color .15s, box-shadow .15s;
}
input:focus, select:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(147,197,253,.18) }
.grid-3{display:grid; gap:12px; grid-template-columns:repeat(3, 1fr)}
.grid-2{display:grid; gap:12px; grid-template-columns:1fr 1fr}
@media (max-width:840px){ .grid-3{grid-template-columns:1fr 1fr} }
@media (max-width:620px){ .grid-3, .grid-2{grid-template-columns:1fr} }

.kv-list{display:flex; flex-direction:column; gap:8px; margin-top:6px}
.kv-row{ display:grid; grid-template-columns:1fr auto 1fr auto; align-items:center; gap:8px }
.kv-row .sep{ color:var(--muted); opacity:.7 }
.icon-btn{
  border:1px solid var(--border); background:transparent; color:var(--muted);
  padding:8px 10px; border-radius:10px; cursor:pointer
}
.icon-btn:hover{ color:#fff; border-color:#3a465d }
.icon-btn.remove{ border-color:#3a2430 }
.icon-btn.remove:hover{ background:#25121b; color:#fff }

.actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap}
.btn{
  appearance:none; border:none; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer;
  transition:transform .04s ease, box-shadow .15s ease; background:#121828; color:#e3ebff; border:1px solid var(--border)
}
.btn:active{ transform:translateY(1px) }
.btn.primary{ background:linear-gradient(180deg, var(--accent), #3f79e0); color:white; box-shadow:0 6px 20px rgba(78,140,255,.25) }
.btn.light{ background:transparent; color:var(--text) }
.btn.ghost{ background:transparent; color:var(--muted); border-style:dashed }
.btn.success{ background:linear-gradient(180deg, var(--success), #1b9f4f); color:white }
.btn.small{ padding:8px 12px; font-weight:600 }

.preview-bar, .list-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px }
.result{
  display:block; width:100%; background:transparent; border:1px dashed var(--border);
  border-radius:12px; padding:16px; min-height:56px; word-break:break-all;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace
}
.qr{ display:flex; justify-content:center; padding:12px }
.hidden{ display:none }
.warn{ color:var(--danger); margin-top:10px }
.url-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px }
.url-item{ display:flex; gap:12px; align-items:center; justify-content:space-between; border:1px solid var(--border); border-radius:12px; padding:10px 12px }
.url-item .meta{ display:flex; flex-direction:column; gap:4px }
.url-item .title{ font-weight:700 }
.url-item .link{ font-family:ui-monospace,monospace; max-width:600px; word-break:break-all; color:var(--muted) }
.footer{ color:var(--muted); text-align:center; margin-top:10px; font-size:.9rem }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">
      <span class="logo">U</span>
      <h1>UTM Generator <span class="muted">Pro</span></h1>
    </div>
    <div class="app-actions">
      <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">☼</button>
      <button id="newEntry" class="btn ghost" title="New entry">+ New</button>
      <button id="exportCsv" class="btn light">Export CSV</button>
      <button id="exportJson" class="btn light">Export JSON</button>
      <a id="helpLink" class="btn ghost" href="#help" title="Help">Help</a>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="toolbar">
        <div class="field">
          <label for="preset">Preset</label>
          <select id="preset" aria-label="Select preset">
            <option value="">None</option>
            <option value="google_ads">Google Ads</option>
            <option value="email_campaign">Email Campaign</option>
            <option value="social_paid">Social (Paid)</option>
            <option value="social_organic">Social (Organic)</option>
            <option value="influencer">Influencer</option>
            <option value="affiliate">Affiliate</option>
          </select>
        </div>
        <div class="field inline">
          <label class="toggle">
            <input type="checkbox" id="encodeValues" checked />
            <span>Auto-encode</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="forceLower" />
            <span>Lowercase</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="stripUtmExisting" checked />
            <span>Strip existing UTM</span>
          </label>
        </div>
      </div>

      <form id="utmForm" autocomplete="on">
        <div class="field">
          <label for="baseUrl">Base URL <span class="req">*</span></label>
          <input type="url" id="baseUrl" name="baseUrl" placeholder="https://example.com/landing" required />
          <small class="hint">Must start with http:// or https://</small>
        </div>

        <div class="grid-3">
          <div class="field">
            <label for="utm_source">utm_source <span class="req">*</span></label>
            <input type="text" id="utm_source" placeholder="google, newsletter, partner" required />
          </div>
          <div class="field">
            <label for="utm_medium">utm_medium <span class="req">*</span></label>
            <input type="text" id="utm_medium" placeholder="cpc, email, social" required />
          </div>
          <div class="field">
            <label for="utm_campaign">utm_campaign <span class="req">*</span></label>
            <input type="text" id="utm_campaign" placeholder="spring_sale, launch_q1" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="utm_term">utm_term</label>
            <input type="text" id="utm_term" placeholder="keyword (optional)" />
          </div>
          <div class="field">
            <label for="utm_content">utm_content</label>
            <input type="text" id="utm_content" placeholder="banner_a, variant_1 (optional)" />
          </div>
        </div>

        <div class="field">
          <label>Custom parameters</label>
          <div id="customParams" class="kv-list"></div>
          <br>
          <button type="button" id="addParamBtn" class="btn ghost small">+ Add parameter</button>
          <small class="hint">Examples: ref=affiliate123, promo=BLACKFRIDAY</small>
        </div>

        <div class="actions">
          <button type="reset" class="btn light" id="resetBtn">Reset</button>
          <button type="button" class="btn" id="shareBtn">Share link</button>
          <button type="button" class="btn primary" id="copyBtn">Copy URL</button>
          <button type="button" class="btn success" id="saveBtn">Add to list</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="preview-bar">
        <h2>Preview</h2>
        <div class="right">
          <button id="qrBtn" class="btn light">Show QR</button>
        </div>
      </div>
      <output id="resultUrl" class="result" tabindex="0" aria-live="polite"></output>
      <div id="qrWrap" class="qr hidden" aria-hidden="true">
        <canvas id="qrCanvas" width="256" height="256" aria-label="QR code"></canvas>
      </div>
      <p id="warn" class="warn hidden" role="alert"></p>
    </section>

    <section class="card">
      <div class="list-header">
        <h2>Saved URLs</h2>
        <div class="right">
          <button id="clearList" class="btn ghost">Clear list</button>
        </div>
      </div>
      <ul id="urlList" class="url-list"></ul>
    </section>

    <section id="help" class="card">
      <h2>Help</h2>
      <ul class="help-list">
        <li><strong>Presets</strong> populate source/medium/content/term with sensible defaults.</li>
        <li><strong>Share link</strong> copies a link with your current form state in the URL hash.</li>
        <li><strong>Saved URLs</strong> are kept in your browser (localStorage). Export anytime as CSV/JSON.</li>
        <li><strong>QR</strong> generates a QR code of the final URL for quick testing.</li>
      </ul>
    </section>
  </main>

  <template id="kvRowTemplate">
    <div class="kv-row">
      <input class="kv-key" type="text" placeholder="key" aria-label="Parameter key" />
      <span class="sep">=</span>
      <input class="kv-val" type="text" placeholder="value" aria-label="Parameter value" />
      <button type="button" class="icon-btn remove" title="Remove parameter" aria-label="Remove parameter">×</button>
    </div>
  </template>

  <script src="app.js"></script>
</body>
  <script>

    // UTM Generator Pro – advanced features
(function () {
  const $ = (id) => document.getElementById(id);
  const qs = (sel, el = document) => el.querySelector(sel);
  const qsa = (sel, el = document) => [...el.querySelectorAll(sel)];

  // Elements
  const form = $('utmForm');
  const baseUrl = $('baseUrl');
  const utm_source = $('utm_source');
  const utm_medium = $('utm_medium');
  const utm_campaign = $('utm_campaign');
  const utm_term = $('utm_term');
  const utm_content = $('utm_content');
  const preset = $('preset');

  const encodeValues = $('encodeValues');
  const forceLower = $('forceLower');
  const stripUtmExisting = $('stripUtmExisting');

  const result = $('resultUrl');
  const copyBtn = $('copyBtn');
  const shareBtn = $('shareBtn');
  const saveBtn = $('saveBtn');
  const addParamBtn = $('addParamBtn');
  const customParams = $('customParams');
  const kvTemplate = $('kvRowTemplate');

  const warn = $('warn');
  const qrBtn = $('qrBtn');
  const qrWrap = $('qrWrap');
  const qrCanvas = $('qrCanvas');

  const themeToggle = $('themeToggle');
  const newEntry = $('newEntry');
  const exportCsv = $('exportCsv');
  const exportJson = $('exportJson');
  const urlList = $('urlList');
  const clearList = $('clearList');

  // ---- State ----
  const STORAGE_KEY = 'utm_generator_pro_state_v2';
  const LIST_KEY = 'utm_generator_pro_list_v2';

  // ---- Helpers ----
  function normalizeVal(v) {
    let out = v.trim();
    if (forceLower.checked) out = out.toLowerCase();
    return encodeValues.checked ? encodeURIComponent(out) : out;
  }
  function isValidHttpUrl(string) {
    try { const u = new URL(string); return u.protocol === 'http:' || u.protocol === 'https:'; }
    catch (_) { return false; }
  }
  function removeExistingUtm(u) {
    const url = new URL(u);
    const del = [];
    url.searchParams.forEach((_, k) => { if (/^utm_/i.test(k)) del.push(k); });
    del.forEach(k => url.searchParams.delete(k));
    return url.toString();
  }
  function currentCustomRows() {
    return qsa('.kv-row', customParams).map(row => ({
      k: qs('.kv-key', row).value,
      v: qs('.kv-val', row).value
    }));
  }
  function setWarning(msg='') {
    if (!msg) { warn.classList.add('hidden'); warn.textContent=''; return; }
    warn.textContent = msg; warn.classList.remove('hidden');
  }

  // ---- Presets ----
  const PRESETS = {
    google_ads: { source: 'google', medium: 'cpc', content: 'ad', term: '' },
    email_campaign: { source: 'newsletter', medium: 'email', content: 'body', term: '' },
    social_paid: { source: 'facebook', medium: 'paid_social', content: 'feed_ad', term: '' },
    social_organic: { source: 'linkedin', medium: 'social', content: 'post', term: '' },
    influencer: { source: 'influencer', medium: 'social', content: 'story', term: '' },
    affiliate: { source: 'affiliate', medium: 'referral', content: 'textlink', term: '' }
  };
  preset.addEventListener('change', () => {
    const p = PRESETS[preset.value];
    if (!p) return;
    utm_source.value = p.source;
    utm_medium.value = p.medium;
    utm_content.value = p.content;
    utm_term.value = p.term;
    buildUrl();
  });

  // ---- Build URL ----
  function buildUrl() {
    const base = baseUrl.value.trim();
    if (!isValidHttpUrl(base)) {
      result.textContent = '';
      setWarning('Enter a valid Base URL (must start with http:// or https://).');
      return;
    }
    setWarning('');

    let finalBase = base;
    if (stripUtmExisting.checked) finalBase = removeExistingUtm(base);
    const url = new URL(finalBase);

    const required = {
      utm_source: utm_source.value,
      utm_medium: utm_medium.value,
      utm_campaign: utm_campaign.value
    };
    for (const [k, v] of Object.entries(required)) {
      if (!v.trim()) {
        result.textContent = '';
        setWarning(`Missing required: ${k}`);
        return;
      }
    }

    url.searchParams.set('utm_source', normalizeVal(utm_source.value));
    url.searchParams.set('utm_medium', normalizeVal(utm_medium.value));
    url.searchParams.set('utm_campaign', normalizeVal(utm_campaign.value));
    if (utm_term.value.trim()) url.searchParams.set('utm_term', normalizeVal(utm_term.value));
    if (utm_content.value.trim()) url.searchParams.set('utm_content', normalizeVal(utm_content.value));

    for (const { k, v } of currentCustomRows()) {
      if (!k.trim()) continue;
      const key = forceLower.checked ? k.trim().toLowerCase() : k.trim();
      const val = encodeValues.checked ? encodeURIComponent(v.trim()) : v.trim();
      url.searchParams.set(key, val);
    }

    const out = url.toString();
    result.textContent = out;
    drawQR(out);
    saveState(); // autosave
  }

  function addParam(key = '', value = '') {
    const node = kvTemplate.content.firstElementChild.cloneNode(true);
    const k = qs('.kv-key', node);
    const v = qs('.kv-val', node);
    const rm = qs('.remove', node);
    k.value = key; v.value = value;
    const update = () => buildUrl();
    k.addEventListener('input', update);
    v.addEventListener('input', update);
    rm.addEventListener('click', () => { node.remove(); buildUrl(); });
    customParams.appendChild(node);
  }

  // Prefill one empty row
  addParam();

  // Live updates
  [baseUrl, utm_source, utm_medium, utm_campaign, utm_term, utm_content].forEach(el => {
    el.addEventListener('input', buildUrl);
  });
  [encodeValues, forceLower, stripUtmExisting].forEach(el => el.addEventListener('change', buildUrl));
  addParamBtn.addEventListener('click', () => addParam());

  // Copy & Share
  copyBtn.addEventListener('click', async () => {
    const text = result.textContent.trim();
    if (!text || !isValidHttpUrl(text)) return;
    await navigator.clipboard.writeText(text).catch(()=>{});
    flash(copyBtn, 'Copied!');
  });
  shareBtn.addEventListener('click', async () => {
    const link = shareLinkFromState();
    await navigator.clipboard.writeText(link).catch(()=>{});
    flash(shareBtn, 'Link copied!');
  });

  // Save to list
  saveBtn.addEventListener('click', () => {
    const url = result.textContent.trim();
    if (!url) return;
    const title = prompt('Optional title/label for this URL:', utm_campaign.value || 'Campaign');
    const item = { title: (title||'Campaign').trim(), url, ts: Date.now() };
    const list = loadList();
    list.unshift(item);
    localStorage.setItem(LIST_KEY, JSON.stringify(list));
    renderList();
    flash(saveBtn, 'Saved');
  });
  clearList.addEventListener('click', () => {
    if (confirm('Clear saved list?')) {
      localStorage.removeItem(LIST_KEY);
      renderList();
    }
  });

  // New entry (reset)
  newEntry.addEventListener('click', () => form.reset());

  form.addEventListener('reset', () => {
    setTimeout(() => {
      customParams.innerHTML = '';
      addParam();
      buildUrl();
      saveState();
    }, 0);
  });

  // Theme
  themeToggle.addEventListener('click', () => {
    const html = document.documentElement;
    const next = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', next);
    localStorage.setItem('utm_theme', next);
  });

  // Export
  exportCsv.addEventListener('click', () => {
    const list = loadList();
    if (!list.length) return;
    const rows = [['title','url','timestamp']].concat(list.map(i => [i.title, i.url, new Date(i.ts).toISOString()]));
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\\n');
    downloadFile('utm-links.csv', 'text/csv', csv);
  });
  exportJson.addEventListener('click', () => {
    const list = loadList();
    if (!list.length) return;
    downloadFile('utm-links.json', 'application/json', JSON.stringify(list, null, 2));
  });

  function downloadFile(name, type, content) {
    const blob = new Blob([content], { type });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // ---- Shareable state via URL hash ----
  function stateFromForm() {
    return {
      baseUrl: baseUrl.value,
      utm_source: utm_source.value,
      utm_medium: utm_medium.value,
      utm_campaign: utm_campaign.value,
      utm_term: utm_term.value,
      utm_content: utm_content.value,
      custom: currentCustomRows(),
      forceLower: forceLower.checked,
      encodeValues: encodeValues.checked,
      stripUtmExisting: stripUtmExisting.checked
    };
  }
  function applyState(s) {
    if (s.baseUrl) baseUrl.value = s.baseUrl;
    ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'].forEach(k => { if (s[k] !== undefined) $(k).value = s[k]; });
    if (Array.isArray(s.custom)) {
      customParams.innerHTML = '';
      s.custom.forEach(({k,v}) => addParam(k,v));
    }
    if (typeof s.forceLower === 'boolean') forceLower.checked = s.forceLower;
    if (typeof s.encodeValues === 'boolean') encodeValues.checked = s.encodeValues;
    if (typeof s.stripUtmExisting === 'boolean') stripUtmExisting.checked = s.stripUtmExisting;
  }
  function shareLinkFromState() {
    const state = stateFromForm();
    const hash = encodeURIComponent(JSON.stringify(state));
    return location.origin + location.pathname + '#' + hash;
  }
  function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(stateFromForm())); } catch {}
  }
  function loadState() {
    try {
      // priority: URL hash
      const hash = location.hash.slice(1);
      if (hash) {
        const s = JSON.parse(decodeURIComponent(hash));
        applyState(s);
        return;
      }
      // else localStorage
      const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
      if (s) applyState(s);
    } catch {}
  }
  function loadList() {
    try { return JSON.parse(localStorage.getItem(LIST_KEY) || '[]'); } catch { return []; }
  }
  function renderList() {
    const list = loadList();
    urlList.innerHTML = '';
    if (!list.length) {
      const li = document.createElement('li');
      li.className = 'url-item';
      li.innerHTML = '<div class="meta"><span class="title">No saved URLs yet</span><span class="link">Use “Add to list”.</span></div>';
      urlList.appendChild(li);
      return;
    }
    for (const item of list) {
      const li = document.createElement('li');
      li.className = 'url-item';
      const time = new Date(item.ts).toLocaleString();
      li.innerHTML = `
        <div class="meta">
          <span class="title">${escapeHtml(item.title)}</span>
          <a class="link" href="${escapeAttr(item.url)}" target="_blank" rel="noopener">${escapeHtml(item.url)}</a>
          <small class="muted">${time}</small>
        </div>
        <div class="row-actions">
          <button class="btn light copy">Copy</button>
          <button class="btn ghost del">Delete</button>
        </div>`;
      qs('.copy', li).addEventListener('click', async () => {
        await navigator.clipboard.writeText(item.url).catch(()=>{});
        flash(qs('.copy', li), 'Copied!');
      });
      qs('.del', li).addEventListener('click', () => {
        const list2 = loadList().filter(x => !(x.url === item.url && x.ts === item.ts));
        localStorage.setItem(LIST_KEY, JSON.stringify(list2));
        renderList();
      });
      urlList.appendChild(li);
    }
  }
  function flash(btn, text) {
    const prev = btn.textContent;
    btn.textContent = text;
    btn.disabled = true;
    setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; }, 1000);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeAttr(s){ return String(s).replace(/"/g, '&quot;'); }

  // ---- Minimal QR generator (qrcode algorithm, numeric/alphanumeric/byte) ----
  // Lightweight implementation adapted for inline use (no network / no deps)
  // Source: simplified & inlined from public domain references.
  // For brevity, this supports version auto-select up to 10, ECC level M.
  // (Good enough for URLs up to a few hundred characters.)
  const QRUtil = (function(){
    // A tiny implementation using third-party–like logic but rewritten and minimized.
    // Due to size, we'll include a very compact lib (credit: qrcode.js public domain, trimmed).
    /* eslint-disable */
    var QR8bitByte=function(data){this.mode=4;this.data=data;};QR8bitByte.prototype.getLength=function(){return this.data.length};QR8bitByte.prototype.write=function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8)}};var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1),G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1),G15_MASK:(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1),getBCHTypeInfo:function(data){for(var d=data<<10;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0;)d^=QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15));return(data<<10)|d},getBCHTypeNumber:function(data){for(var d=data<<12;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0;)d^=QRUtil.G18<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18));return(data<<12)|d},getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1}return digit},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1]},mask:function(pat,i,j){switch(pat){case 0:return (i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return (i+j)%3==0;case 4:return (Math.floor(i/2)+Math.floor(j/3))%2==0;case 5:return (i*j)%2+(i*j)%3==0;case 6:return ((i*j)%2+(i*j)%3)%2==0;case 7:return ((i*j)%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+pat)}}};var QRMath=function(){var EXP_TABLE=new Array(256);var LOG_TABLE=new Array(256);for(var i=0;i<8;i++)EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)EXP_TABLE[i]=EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8];for(i=0;i<255;i++)LOG_TABLE[EXP_TABLE[i]]=i;return{glog:function(n){if(n<1)throw new Error("glog("+n+")");return LOG_TABLE[n]},gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return EXP_TABLE[n]}};}();var QRPolynomial=function(num,shift){if(num.length==undefined)throw new Error(num.length+"/"+shift);var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];};QRPolynomial.prototype.get=function(index){return this.num[index]};QRPolynomial.prototype.getLength=function(){return this.num.length};QRPolynomial.prototype.multiply=function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)};QRPolynomial.prototype.mod=function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)};var QRRSBlocks=function(){var RS_BLOCK_TABLE=[
    // L, M, Q, H (we use M only; keep table compact for v1..10)
    // typeNumber, [M: total data, blocks, data per block]
    [1,   16,1,16],
    [2,   28,1,28],
    [3,   44,1,44],
    [4,   64,2,32],
    [5,   86,2,43],
    [6,  108,2,54],
    [7,  124,3,41],
    [8,  154,4,38],
    [9,  182,4,45],
    [10, 216,4,54]
  ];
    return {getRSBlocks:function(typeNumber){for(var i=0;i<RS_BLOCK_TABLE.length;i++){if(RS_BLOCK_TABLE[i][0]==typeNumber){var t=RS_BLOCK_TABLE[i];return[{totalCount:t[2],dataCount:t[3]}]}}throw new Error("bad rs block")}};}();
  function QRBitBuffer(){this.buffer=[];this.length=0}
  QRBitBuffer.prototype.get=function(i){return (this.buffer[Math.floor(i/8)]>>> (7-i%8) &1)==1}
  QRBitBuffer.prototype.put=function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>> (length-i-1))&1)==1)}
  QRBitBuffer.prototype.getLengthInBits=function(){return this.length}
  QRBitBuffer.prototype.putBit=function(bit){this.buffer[Math.floor(this.length/8)]>>>=0;if(bit)this.buffer[Math.floor(this.length/8)]|=128>>> (this.length%8);this.length++}
  function QRCode(typeNumber){this.typeNumber=typeNumber;this.modules=null;this.moduleCount=0;this.dataList=[]}
  QRCode.prototype.addData=function(data){this.dataList.push(new QR8bitByte(data))}
  QRCode.prototype.make=function(){
    // choose mask 0 for simplicity
    makeImpl(this, 0);
  }
  function makeImpl(qr, maskPattern){
    qr.moduleCount=qr.typeNumber*4+17; qr.modules=new Array(qr.moduleCount);
    for(var row=0;row<qr.moduleCount;row++){qr.modules[row]=new Array(qr.moduleCount);for(var col=0;col<qr.moduleCount;col++)qr.modules[row][col]=null}
    setupPositionProbePattern(0,0,qr); setupPositionProbePattern(qr.moduleCount-7,0,qr); setupPositionProbePattern(0,qr.moduleCount-7,qr);
    setupTimingPattern(qr); if(qr.typeNumber>=2) setupPositionAdjustPattern(qr);
    var data=createData(qr.typeNumber, qr.dataList);
    mapData(qr, data, maskPattern);
  }
  function setupPositionProbePattern(row,col,qr){
    for(var r=-1;r<=7;r++){if(row+r<=-1||qr.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||qr.moduleCount<=col+c)continue;qr.modules[row+r][col+c]=(0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)}}
  }
  function setupTimingPattern(qr){
    for(var r=8;r<qr.moduleCount-8;r++) if(qr.modules[r][6]==null) qr.modules[r][6]=(r%2==0);
    for(var c=8;c<qr.moduleCount-8;c++) if(qr.modules[6][c]==null) qr.modules[6][c]=(c%2==0);
  }
  function setupPositionAdjustPattern(qr){
    var pos = QRUtil.getPatternPosition(qr.typeNumber);
    for(var i=0;i<pos.length;i++) for(var j=0;j<pos.length;j++){
      var row=pos[i], col=pos[j]; if(qr.modules[row][col]!=null) continue;
      for(var r=-2;r<=2;r++) for(var c=-2;c<=2;c++) qr.modules[row+r][col+c]=(Math.max(Math.abs(r),Math.abs(c))!=1);
    }
  }
  function createData(typeNumber, dataList){
    var buffer=new QRBitBuffer();
    for(var i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.mode,4);buffer.put(data.getLength(),8);data.write(buffer)}
    // length limits for typeNumber M (simplified): ensure not overflow
    // pad to capacity
    var totalDataCount = QRRSBlocks.getRSBlocks(typeNumber)[0].dataCount;
    for(var i=0;i<4 && buffer.getLengthInBits()<totalDataCount*8;i++) buffer.put(0,1);
    while(buffer.getLengthInBits()%8!=0) buffer.put(0,1);
    var bytes=[]; for(i=0;i<buffer.getLengthInBits()/8;i++) bytes.push(buffer.buffer[i]||0);
    while(bytes.length<totalDataCount){ bytes.push(0xec); if(bytes.length<totalDataCount) bytes.push(0x11) }
    return bytes;
  }
  function mapData(qr, data, maskPattern){
    var inc=-1,row=qr.moduleCount-1,bitIndex=7,byteIndex=0;
    for(var col=qr.moduleCount-1; col>0; col-=2){
      if(col==6) col--;
      while(true){
        for(var c=0;c<2;c++) if(qr.modules[row][col-c]==null){
          var dark=false;
          if(byteIndex < data.length){
            dark = (((data[byteIndex]>>>bitIndex)&1)==1);
          }
          if(QRUtil.mask(maskPattern, row, col-c)) dark=!dark;
          qr.modules[row][col-c]=dark;
          bitIndex--; if(bitIndex==-1){byteIndex++; bitIndex=7}
        }
        row += inc;
        if(row<0 || qr.moduleCount<=row){ row-=inc; inc=-inc; break; }
      }
    }
  }
  function estimateTypeForLength(len){
    // crude mapping for version 1..10
    const caps=[16,28,44,64,86,108,124,154,182,216];
    for(let i=0;i<caps.length;i++){ if(len<=caps[i]) return i+1; }
    return 10;
  }
  function drawQRToCanvas(canvas, text){
    const type = estimateTypeForLength(text.length);
    const qr = new QRCode(type);
    qr.addData(text); qr.make();
    const size = canvas.width;
    const count = qr.moduleCount;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,size,size);
    const scale = Math.floor(size / (count+8));
    const margin = Math.floor((size - count*scale)/2);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#000';
    for(let r=0;r<count;r++){
      for(let c=0;c<count;c++){
        if(qr.modules[r][c]) ctx.fillRect(margin+c*scale, margin+r*scale, scale, scale);
      }
    }
  }
  /* eslint-enable */
  return { drawQRToCanvas };
  })();

  function drawQR(text){
    if (!text || !isValidHttpUrl(text)) { qrWrap.classList.add('hidden'); return; }
    QRUtil.drawQRToCanvas(qrCanvas, text);
  }
  qrBtn.addEventListener('click', () => {
    qrWrap.classList.toggle('hidden');
  });

  // ---- Init ----
  (function init(){
    // Theme
    const theme = localStorage.getItem('utm_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    // Restore form/list
    loadState();
    renderList();
    buildUrl();
  })();
})();
  </script>
</html>
